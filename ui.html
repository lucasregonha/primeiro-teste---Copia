<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<style>
body {
  font-family: Inter, sans-serif;
  padding: 12px;
  margin: 0;
  font-size: 12px;
}

.tabs {
  display: flex;
  gap: 4px;
  margin-bottom: 12px;
  border-bottom: 1px solid #e0e0e0;
}

.tab {
  padding: 8px 16px;
  cursor: pointer;
  border-bottom: 2px solid transparent;
  color: #777;
  font-weight: 500;
}

.tab.active {
  color: #333;
  border-bottom-color: #0066FF;
}

.top-bar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 10px;
}

.group {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 8px;
  border-radius: 8px;
  background: #f4f4f4;
  margin-bottom: 6px;
  cursor: pointer;
}
.group:hover { background: #eaeaea; }

.group-left {
  display: flex;
  flex-direction: column;
  gap: 2px;
}

.group-right {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 2px;
}

.swatch {
  width: 26px;
  height: 26px;
  border-radius: 6px;
  border: 1px solid #ddd;
}

.type-label {
  font-size: 9px;
  color: #555;
  line-height: 1;
}

.detail {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 10px;
  margin-top: 20px;
}

.detail-swatch {
  width: 64px;
  height: 64px;
  border-radius: 12px;
  border: 1px solid #ddd;
}

.text-preview {
  padding: 16px;
  border: 1px solid #ddd;
  border-radius: 8px;
  background: white;
  text-align: center;
  width: 100%;
  box-sizing: border-box;
}

.text-info {
  display: flex;
  flex-direction: column;
  gap: 4px;
  font-size: 11px;
  color: #555;
  text-align: center;
}

#hex-code {
  font-size: 12px;
  color: #333;
}

.nav {
  display: flex;
  gap: 8px;
}

button {
  padding: 6px 10px;
  border-radius: 6px;
  border: 1px solid #ccc;
  cursor: pointer;
}

.back {
  margin-top: 20px;
  font-size: 11px;
  cursor: pointer;
  text-decoration: underline;
}

.select-all {
  margin-top: 10px;
}

.empty {
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  height: 100%;
  text-align: center;
  color: #777;
}
</style>
</head>

<body>
<div class="tabs">
  <div class="tab active" onclick="switchTab('colors')">Cores</div>
  <div class="tab" onclick="switchTab('typography')">Tipografia</div>
</div>

<div id="top-bar-container"></div>
<div id="app"></div>

<script>
const app = document.getElementById("app");
const topBarContainer = document.getElementById("top-bar-container");

let viewMode = "list";
let currentGroup = null;
let currentIndex = 0;
let showHidden = false;
let lastGroups = [];
let currentTab = "colors";

function switchTab(tab) {
  currentTab = tab;
  
  // Atualiza visual das tabs
  document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
  const tabs = document.querySelectorAll(".tab");
  if (tab === "colors") {
    tabs[0].classList.add("active");
  } else {
    tabs[1].classList.add("active");
  }
  
  // Notifica o plugin
  parent.postMessage({ pluginMessage: { type: "switch-tab", tab } }, "*");
  
  // Reseta view
  viewMode = "list";
  currentGroup = null;
  lastGroups = [];
}

function renderTopBar(show) {
  topBarContainer.innerHTML = "";
  if (!show || viewMode !== "list") return;

  const div = document.createElement("div");
  div.className = "top-bar";
  div.innerHTML = `
    <label>
      <input type="checkbox" ${showHidden ? "checked" : ""}/> Exibir elementos ocultos
    </label>
  `;

  div.querySelector("input").addEventListener("change", e => {
    showHidden = e.target.checked;
    parent.postMessage({ pluginMessage: { type: "toggle-hidden", value: showHidden } }, "*");
  });

  topBarContainer.appendChild(div);
}

function paintToCss(paint, node) {
  if (!paint) return "#000";

  if (paint.type === "SOLID") {
    const r = Math.round(paint.color.r * 255);
    const g = Math.round(paint.color.g * 255);
    const b = Math.round(paint.color.b * 255);
    let a = paint.opacity ?? 1;
    if (node?.opacity) a *= node.opacity;
    return `rgba(${r},${g},${b},${a})`;
  }

  if (paint.type.startsWith("GRADIENT")) {
    const stops = paint.gradientStops.map(s => {
      const r = Math.round(s.color.r * 255);
      const g = Math.round(s.color.g * 255);
      const b = Math.round(s.color.b * 255);
      return `rgba(${r},${g},${b},${s.color.a}) ${s.position * 100}%`;
    }).join(", ");
    return `linear-gradient(90deg, ${stops})`;
  }

  return "#000";
}

// Converte o estilo do Figma (ex: "Bold Italic") para propriedades CSS
function parseFigmaFontStyle(fontStyle, fontWeight) {
  let cssWeight = typeof fontWeight === "number" ? fontWeight : 400;
  let cssStyle = "normal";
  
  const styleLower = fontStyle.toLowerCase();
  
  // Detecta italic/oblique
  if (styleLower.includes("italic") || styleLower.includes("oblique")) {
    cssStyle = "italic";
  }
  
  // Mapeia estilos comuns para pesos
  if (styleLower.includes("thin")) cssWeight = 100;
  else if (styleLower.includes("extralight") || styleLower.includes("extra light")) cssWeight = 200;
  else if (styleLower.includes("light")) cssWeight = 300;
  else if (styleLower.includes("regular") || styleLower.includes("normal")) cssWeight = 400;
  else if (styleLower.includes("medium")) cssWeight = 500;
  else if (styleLower.includes("semibold") || styleLower.includes("semi bold")) cssWeight = 600;
  else if (styleLower.includes("bold")) cssWeight = 700;
  else if (styleLower.includes("extrabold") || styleLower.includes("extra bold")) cssWeight = 800;
  else if (styleLower.includes("black") || styleLower.includes("heavy")) cssWeight = 900;
  
  return { weight: cssWeight, style: cssStyle };
}

function selectCurrentNode() {
  if (!currentGroup) return;
  const entry = currentTab === "colors" 
    ? currentGroup.nodePaints[currentIndex]
    : currentGroup.nodeStyles[currentIndex];
  parent.postMessage({
    pluginMessage: { type: "select-node", nodeId: entry.nodeId }
  }, "*");
}

onmessage = e => {
  const msg = e.data.pluginMessage;
  if (msg.type === "empty") renderEmpty();
  if (msg.type === "result-colors" && currentTab === "colors") renderColorList(msg.groups);
  if (msg.type === "result-typography" && currentTab === "typography") renderTypographyList(msg.groups);
  if (msg.type === "init-tab") {
    currentTab = msg.tab;
  }
};

function renderEmpty() {
  viewMode = "list";
  renderTopBar(false);
  app.innerHTML = `<div class="empty"><strong>Selecione um ou mais frames</strong></div>`;
}

function renderColorList(groups) {
  viewMode = "list";
  renderTopBar(true);
  lastGroups = groups;

  if (!groups.length) {
    app.innerHTML = `
      <div class="empty">
        Todos os elementos do frame<br>
        <span style="color:#2ECC71">utilizam tokens de cor</span>
      </div>
    `;
    return;
  }

  app.innerHTML = `
    <h3>Elementos sem token aplicado</h3>
    ${groups.map(g => {
      const np = g.nodePaints[0];
      const swatch = paintToCss(np.paint, np.node);

      const typeLabel =
        g.nodePaints.every(n => n.isStroke) ? "Stroke" :
        g.nodePaints.every(n => !n.isStroke) ? "Fill" : "Mix";

      return `
        <div class="group" onclick='openDetail(${JSON.stringify(g)})'>
          <div class="group-left">
            <strong>${g.hex}</strong>
            ${g.nodePaints.length} elementos
          </div>
          <div class="group-right">
            <div class="swatch" style="background:${swatch}"></div>
            <div class="type-label">${typeLabel}</div>
          </div>
        </div>
      `;
    }).join("")}
  `;
}

function renderTypographyList(groups) {
  viewMode = "list";
  renderTopBar(true);
  lastGroups = groups;

  if (!groups.length) {
    app.innerHTML = `
      <div class="empty">
        Todos os textos do frame<br>
        <span style="color:#2ECC71">utilizam tokens de tipografia</span>
      </div>
    `;
    return;
  }

  app.innerHTML = `
    <h3>Textos sem token aplicado</h3>
    ${groups.map(g => {
      const style = g.style;
      const fontWeight = typeof style.fontWeight === "number" ? style.fontWeight : 400;
      const cssFont = parseFigmaFontStyle(style.fontStyle, fontWeight);

      return `
        <div class="group" onclick='openTypographyDetail(${JSON.stringify(g)})'>
          <div class="group-left">
            <strong>${style.fontFamily} ${style.fontStyle}</strong>
            ${g.nodeStyles.length} elementos
          </div>
          <div class="group-right">
            <div style="font-family: '${style.fontFamily}', sans-serif; font-weight: ${cssFont.weight}; font-style: ${cssFont.style}; font-size: 20px; line-height: 1;">Aa</div>
          </div>
        </div>
      `;
    }).join("")}
  `;
}

function openDetail(group) {
  currentGroup = group;
  currentIndex = 0;
  viewMode = "detail";
  topBarContainer.innerHTML = "";
  renderColorDetail();
  selectCurrentNode();
}

function openTypographyDetail(group) {
  currentGroup = group;
  currentIndex = 0;
  viewMode = "detail";
  topBarContainer.innerHTML = "";
  renderTypographyDetail();
  selectCurrentNode();
}

function renderColorDetail() {
  const entry = currentGroup.nodePaints[currentIndex];
  const bg = paintToCss(entry.paint, entry.node);

  app.innerHTML = `
    <div class="detail">
      <div class="detail-swatch" style="background:${bg}"></div>
      <div id="hex-code">${currentGroup.hex}</div>
      <div class="type-label">${entry.isStroke ? "Stroke" : "Fill"}</div>

      <div>${currentIndex + 1} de ${currentGroup.nodePaints.length}</div>

      <div class="nav">
        <button onclick="prev()" ${currentGroup.nodePaints.length <= 1 ? "disabled" : ""}>◀</button>
        <button onclick="next()" ${currentGroup.nodePaints.length <= 1 ? "disabled" : ""}>▶</button>
      </div>

      ${currentGroup.nodePaints.length > 1
        ? `<button class="select-all" onclick="selectAll()">Selecionar todos</button>`
        : ""}

      <div class="back" onclick="back()">Voltar para lista</div>
    </div>
  `;
}

function renderTypographyDetail() {
  const entry = currentGroup.nodeStyles[currentIndex];
  const style = entry.style;
  
  const fontSizeStr = typeof style.fontSize === "number" ? style.fontSize : 16;
  const fontWeightStr = typeof style.fontWeight === "number" ? style.fontWeight : 400;
  const cssFont = parseFigmaFontStyle(style.fontStyle, fontWeightStr);
  
  let lineHeightStr = "Auto";
  if (typeof style.lineHeight === "object" && style.lineHeight.unit !== "AUTO") {
    if (style.lineHeight.unit === "PIXELS") {
      lineHeightStr = `${style.lineHeight.value}px`;
    } else if (style.lineHeight.unit === "PERCENT") {
      lineHeightStr = `${style.lineHeight.value}%`;
    }
  } else if (typeof style.lineHeight === "string") {
    lineHeightStr = style.lineHeight;
  }

  const displayFontSize = typeof style.fontSize === "number" ? `${style.fontSize}px` : style.fontSize;
  const displayFontWeight = typeof style.fontWeight === "number" ? style.fontWeight : style.fontWeight;

  app.innerHTML = `
    <div class="detail">
      <div class="text-preview" style="font-family: '${style.fontFamily}', sans-serif; font-size: ${fontSizeStr}px; font-weight: ${cssFont.weight}; font-style: ${cssFont.style};">
        The quick brown fox jumps
      </div>
      
      <div class="text-info">
        <strong>${style.fontFamily} ${style.fontStyle}</strong>
        <div>Tamanho: ${displayFontSize}</div>
        <div>Peso: ${displayFontWeight}</div>
        <div>Altura da linha: ${lineHeightStr}</div>
      </div>

      <div>${currentIndex + 1} de ${currentGroup.nodeStyles.length}</div>

      <div class="nav">
        <button onclick="prev()" ${currentGroup.nodeStyles.length <= 1 ? "disabled" : ""}>◀</button>
        <button onclick="next()" ${currentGroup.nodeStyles.length <= 1 ? "disabled" : ""}>▶</button>
      </div>

      ${currentGroup.nodeStyles.length > 1
        ? `<button class="select-all" onclick="selectAll()">Selecionar todos</button>`
        : ""}

      <div class="back" onclick="back()">Voltar para lista</div>
    </div>
  `;
}

function next() {
  const items = currentTab === "colors" ? currentGroup.nodePaints : currentGroup.nodeStyles;
  currentIndex = (currentIndex + 1) % items.length;
  
  if (currentTab === "colors") {
    renderColorDetail();
  } else {
    renderTypographyDetail();
  }
  selectCurrentNode();
}

function prev() {
  const items = currentTab === "colors" ? currentGroup.nodePaints : currentGroup.nodeStyles;
  currentIndex = (currentIndex - 1 + items.length) % items.length;
  
  if (currentTab === "colors") {
    renderColorDetail();
  } else {
    renderTypographyDetail();
  }
  selectCurrentNode();
}

function selectAll() {
  const items = currentTab === "colors" ? currentGroup.nodePaints : currentGroup.nodeStyles;
  parent.postMessage({
    pluginMessage: {
      type: "select-multiple-nodes",
      nodeIds: items.map(n => n.nodeId)
    }
  }, "*");
}

function back() {
  viewMode = "list";
  renderTopBar(true);
  
  if (currentTab === "colors") {
    renderColorList(lastGroups);
  } else {
    renderTypographyList(lastGroups);
  }
}
</script>
</body>
</html>